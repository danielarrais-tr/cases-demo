<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OAuth Popup Simulation - Main Window</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 24px; line-height: 1.5; }
        button { padding: 10px 16px; font-size: 15px; cursor: pointer; }
        .row { margin: 12px 0; }
        code { background: #f5f5f5; padding: 2px 4px; border-radius: 4px; }
        .log { white-space: pre-wrap; padding: 12px; background: #fafafa; border: 1px solid #eee; border-radius: 8px; min-height: 80px; }
    </style>
</head>
<body>
    <h1>OAuth via Popup Simulation</h1>
    <p>
        Flow: click Login → opens popup (<code>auth.html</code>) → fill and submit → callback (<code>callback.html</code>) sends an event to the main window → popup closes.
    </p>

    <div class="row">
        <button id="btn-login">Start Login (Popup)</button>
        <button id="btn-login-implicit">Start Login (Implicit)</button>
    </div>

    <div class="row">
        <button id="btn-current-url">Test driver.getCurrentUrl() (simulated)</button>
        <span id="current-url"></span>
    </div>

    <div class="row">
        <strong>State:</strong>
        <div id="state" class="log"></div>
    </div>

    <script src="oauth-sim.js"></script>
    <script>
        (function () {
            const stateEl = document.getElementById('state');
            const currentUrlEl = document.getElementById('current-url');

            const clientId = 'demo-client-id';
            const popupWindowFeatures = 'height=520,width=420,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes';

            function log(message, data) {
                const time = new Date().toISOString();
                stateEl.textContent += `[${time}] ${message}` + (data ? `\n${JSON.stringify(data, null, 2)}` : '') + "\n\n";
            }

            function begin(options) {
                return beginOAuth2(Object.assign({
                    clientId: clientId,
                    popup: true,
                    pkce: true,
                    portal: window.location.origin,
                    redirectUri: new URL('callback.html', window.location.href).toString(),
                    popupWindowFeatures
                }, options));
            }

            document.getElementById('btn-login').addEventListener('click', async () => {
                stateEl.textContent = '';
                log('Starting beginOAuth2 (PKCE) with popup...');
                try {
                    const mgr = await begin({ pkce: true, implicit: false });
                    log('Promise resolved in the main window with token/user:', mgr);
                } catch (err) {
                    log('Error in the authentication flow (popup):', { message: err && err.message, name: err && err.name });
                }
            });

            document.getElementById('btn-login-implicit').addEventListener('click', async () => {
                stateEl.textContent = '';
                log('Starting beginOAuth2 (implicit) with popup...');
                try {
                    const mgr = await begin({ pkce: false, implicit: true });
                    log('Promise resolved in the main window with token/user (implicit):', mgr);
                } catch (err) {
                    log('Error in the authentication flow (implicit):', { message: err && err.message, name: err && err.name });
                }
            });

            document.getElementById('btn-current-url').addEventListener('click', () => {
                // This simulates the Selenium call to driver.getCurrentUrl() right after the popup closes.
                try {
                    const url = window.location.href;
                    currentUrlEl.textContent = url;
                    log('driver.getCurrentUrl() (simulated) returned:', { url });
                } catch (e) {
                    log('driver.getCurrentUrl() (simulated) threw error:', { message: e.message });
                }
            });
        })();
    </script>
</body>
</html>

